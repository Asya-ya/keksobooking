(()=>{"use strict";const e=document.querySelector("#error").content.querySelector(".error"),t=document.querySelector(".map__filters-container"),r=document.querySelector("#success").content.querySelector(".success");let o=null;const n=e=>{((e=>"Escape"===e.key||"Esc"===e.key)(e)||"click"===e.type)&&(e.preventDefault(),o.remove(),document.removeEventListener("keydown",n),document.removeEventListener("click",n))},a=()=>{const t=e.querySelector(".error__button");o=e.cloneNode(!0),document.body.append(o),document.addEventListener("keydown",n),document.addEventListener("click",n),t.addEventListener("click",(()=>o.remove()))},c=["image/jpeg","image/jpg","image/png"],l=(e,t,r)=>{if(c.includes(e.type)){const o=new FileReader,n=document.createElement("img");return t.innerHTML="",n.alt=r,n.className="preview",n.style.width="inherit",n.style.height="inherit",t.append(n),o.addEventListener("load",(()=>{n.src=o.result})),o.readAsDataURL(e),n}},s={BUNGALOW:0,FLAT:1e3,HOTEL:3e3,HOUSE:5e3,PALACE:1e4},i={1:[1],2:[1,2],3:[1,2,3],100:[0]},d=document.querySelector(".ad-form"),u=d.querySelector("#type"),p=d.querySelector("#price"),y=d.querySelector("#timein"),m=d.querySelector("#timeout"),v=d.querySelectorAll("fieldset"),g=d.querySelector("#title"),h=d.querySelector("#room_number"),f=d.querySelector("#capacity"),S=d.querySelector("#address"),q=d.querySelector(".ad-form__reset"),_=d.querySelector("#avatar"),E=d.querySelector(".ad-form-header__preview"),b=E.querySelector("img"),k=d.querySelector("#images"),x=d.querySelector(".ad-form__photo"),$=(e,t,r)=>{e.classList.add(`${r}--disabled`);for(let e of t)e.disabled=!0,e.style.pointerEvents="none"},w=(e,t,r)=>{e.classList.remove(`${r}--disabled`);for(let e of t)e.disabled=!1,e.style.pointerEvents="auto"},C=(e,t)=>{e.setCustomValidity(t),e.style.borderColor="red"},A=e=>{e.setCustomValidity(""),e.style.borderColor="#d9d9d3"},T=()=>{let e=s[u.value.toUpperCase()];p.min=e,p.placeholder=e},N=()=>{const e=Number(p.getAttribute("max")),t=Number(p.getAttribute("min")),r=p.value;r>e?C(p,`Максимальное значение - ${e}`):r<t?C(p,`Минимальное значение для выбранного типа жилья - ${t}`):A(p),p.reportValidity()},D=()=>{i[h.value].includes(parseInt(f.value))?A(f):C(f,"Недопустимое количество гостей."),F(),h.reportValidity(),f.reportValidity()},F=()=>{const e=f.children;for(let t of e)i[h.value].includes(parseInt(t.value))?t.disabled=!1:t.disabled=!0},V=({lat:e,lng:t})=>{S.value=`${e}, ${t}`};F(),u.addEventListener("change",(()=>{T(),N()})),y.addEventListener("change",(()=>{m.value=y.value})),m.addEventListener("change",(()=>{y.value=m.value})),g.addEventListener("input",(()=>{const e=g.value.length,t=g.getAttribute("minlength"),r=g.getAttribute("maxlength");g.validity.tooShort?C(g,`Минимум ${t} символов. Добавьте ещё ${t-e} симв.`):g.validity.tooLong?C(g,`Максимум ${r} символов. Удалите ещё ${e-r} симв.`):g.validity.valueMissing?C(g,"Обязательное поле."):A(g)})),p.addEventListener("input",N),h.addEventListener("change",D),f.addEventListener("change",D),_.addEventListener("change",(()=>{const e=_.files[0];l(e,E,"Аватар пользователя")})),k.addEventListener("change",(()=>{const e=k.files[0];l(e,x,"Фотография жилья")}));const H={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},U=document.querySelector("#card").content.querySelector(".popup"),j="any",M=document.querySelector(".map__filters"),O=M.querySelector("#housing-type"),z=M.querySelector("#housing-price"),I=M.querySelector("#housing-rooms"),P=M.querySelector("#housing-guests"),G=M.querySelectorAll(".map__checkbox"),R=e=>(e=>O.value===e.offer.type||O.value===j)(e)&&(e=>z.value===(e.offer.price<=1e4?"low":e.offer.price>1e4&&e.offer.price<=5e4?"middle":"high")||z.value===j)(e)&&(e=>I.value===String(e.offer.rooms)||I.value===j)(e)&&(e=>P.value===String(e.offer.guests)||P.value===j)(e)&&(e=>{e.offer.features||(e.offer.features=[]);for(let t of G)if(t.checked&&!e.offer.features.includes(t.value))return!1;return!0})(e),B={lat:35.68951,lng:139.69171},W=document.querySelector(".map__filters"),J=W.querySelectorAll(".map__filter"),K=W.querySelector(".map__features"),Q=Array.from(J);Q.push(K);const X=document.querySelector("#map-canvas"),Y=()=>$(W,Q,W.classList[0]),Z=L.map(X),ee=L.icon({iconUrl:"img/main-pin.svg",iconSize:[52,52],iconAnchor:[26,52]}),te=L.marker(B,{draggable:!0,icon:ee});te.addTo(Z),V(B),te.on("moveend",(e=>{const t=e.target.getLatLng().lat.toFixed(5),r=e.target.getLatLng().lng.toFixed(5);V({lat:t,lng:r})}));const re=L.layerGroup().addTo(Z),oe=e=>{re.clearLayers(),e.filter(R).slice(0,10).forEach((e=>{const t=L.icon({iconUrl:"img/pin.svg",iconSize:[40,40],iconAnchor:[20,40]});L.marker({lat:e.location.lat,lng:e.location.lng},{icon:t}).addTo(re).bindPopup((({author:e,offer:t})=>{const r=U.cloneNode(!0);var o,n;return r.querySelector(".popup__title").textContent=t.title,r.querySelector(".popup__text--address").textContent=t.address,r.querySelector(".popup__text--price").textContent=t.price?`${t.price} ₽/ночь`:"",r.querySelector(".popup__type").textContent=H[t.type],r.querySelector(".popup__text--capacity").textContent=t.rooms&&t.guests?`${t.rooms} ${n=t.rooms,1===n?"комната":n>1&&n<5?"комнаты":"комнат"} для ${t.guests} ${o=t.guests,1===o?"гостя":"гостей"}`:"",r.querySelector(".popup__text--time").textContent=t.checkin&&t.checkout?`Заезд после ${t.checkin}, выезд до ${t.checkout}`:"",((e,t)=>{if(e){const r=document.createDocumentFragment();e.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature"),t.classList.add("popup__feature--"+e),r.appendChild(t)})),t.innerHTML="",t.appendChild(r)}else t.classList.add("visually-hidden")})(t.features,r.querySelector(".popup__features")),r.querySelector(".popup__description").textContent=t.description,((e,t)=>{if(e){const r=document.createDocumentFragment();e.forEach((e=>{const o=t.querySelector(".popup__photo").cloneNode(!0);o.src=e,r.appendChild(o)})),t.innerHTML="",t.appendChild(r)}else t.classList.add("visually-hidden")})(t.photos,r.querySelector(".popup__photos")),r.querySelector(".popup__avatar").src=e.avatar,r})(e))}))},ne=()=>{d.reset(),W.reset(),te.setLatLng(B),Z.setView(B,13),V(B),(()=>{const e=E.querySelector(".preview"),t=x.querySelector(".preview");e&&(e.remove(),E.append(b)),t&&t.remove()})(),T()};var ae,ce;Y(),$(d,v,d.classList[0]),Z.on("load",(()=>{w(W,Q,W.classList[0]),w(d,v,d.classList[0])})).setView(B,13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}).addTo(Z),ae=e=>{var t;oe(e),(e=>{O.addEventListener("change",(()=>e())),z.addEventListener("change",(()=>e())),I.addEventListener("change",(()=>e())),P.addEventListener("change",(()=>e()));for(let t of G)t.addEventListener("change",(()=>e()))})(((e,t)=>{let r;return(...t)=>{clearTimeout(r),r=setTimeout((()=>e.apply(void 0,t)),500)}})((()=>oe(e)))),(e=>{d.addEventListener("submit",(t=>{t.preventDefault();const c=new FormData(t.target);var l,s;l=()=>{e(),o=r.cloneNode(!0),document.body.append(o),document.addEventListener("keydown",n),document.addEventListener("click",n)},s=a,fetch("https://23.javascript.pages.academy/keksobooking",{method:"POST",body:c}).then((e=>{e.ok?l():s()})).catch((()=>{s()}))}))})((()=>{ne(),oe(e)})),t=()=>{ne(),oe(e)},q.addEventListener("click",(e=>{e.preventDefault(),t()}))},ce=e=>{Y(),(e=>{t.style.position="relative";const r=document.createElement("div");r.style.zIndex=3,r.style.position="absolute",r.style.left=0,r.style.top=0,r.style.right=0,r.style.bottom=0,r.style.backgroundColor="#000000",r.style.color="#f0f0ea",r.style.textAlign="center",r.style.lineHeight="50px",r.textContent=`Ошибка загрузки данных. ${e}`,t.append(r)})(e)},fetch("https://23.javascript.pages.academy/keksobooking/data").then((e=>{if(e.ok)return e.json();throw new Error(`${e.status}, ${e.statusText}`)})).then((e=>{ae(e)})).catch((e=>{ce(e)}))})();
//# sourceMappingURL=main.bundle.js.map